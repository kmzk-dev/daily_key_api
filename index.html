<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本日のランダムキー</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .key-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2rem;
            word-break: break-all;
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: .3rem;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">本日のランダムキー</span>
            <div class="d-flex align-items-center">
                <label for="lengthSelect" class="text-white me-2">桁数:</label>
                <select id="lengthSelect" class="form-select" style="width: auto;">
                    <option value="8">8桁</option>
                    <option value="10">10桁</option>
                    <option value="12">12桁</option>
                    <option value="15">15桁</option>
                </select>

                <div class="form-check form-switch text-white ms-4">
                    <input class="form-check-input" type="checkbox" role="switch" id="numericOnlyCheckbox">
                    <label class="form-check-label" for="numericOnlyCheckbox">数字のみ</label>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="card">
            <div class="card-body">
                <p class="text-muted">現在の時刻 (JST): <span id="currentTime"></span></p>
                <hr>
                <p class="card-title">取得したランダムキー:</p>
                <div id="randomKeyDisplay" class="key-display text-center mb-3">
                    読み込み中...
                </div>
                <p class="card-text">有効期限: <span id="keyExpiration" class="text-danger"></span></p>
            </div>
        </div>
    </main>

    <footer class="text-center text-muted mt-5 py-3">
        <p>&copy; 2024 - Your Creator Name</p>
    </footer>


    <script>
        'use strict';

        // DOM要素の取得
        const lengthSelect = document.getElementById('lengthSelect');
        const numericOnlyCheckbox = document.getElementById('numericOnlyCheckbox'); // ★★★ 追加
        const currentTimeSpan = document.getElementById('currentTime');
        const randomKeyDisplay = document.getElementById('randomKeyDisplay');
        const keyExpirationSpan = document.getElementById('keyExpiration');

        const API_URL = 'https://fillmee.bambina.jp/daily_key_api/api/jst.php';
        let initialJstDay = null;

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function setCookie(name, value) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (365 * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
        }
        
        function updateJapanTime() {
            const now = new Date();
            const jstString = now.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/\//g, '/');
            currentTimeSpan.textContent = jstString;

            if (initialJstDay !== null) {
                const currentJstDay = now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo', day: 'numeric' });
                if (initialJstDay !== currentJstDay) {
                    console.log('日付が変わりました。APIを再コールします。');
                    const currentType = numericOnlyCheckbox.checked ? 'numeric' : 'alphanumeric';
                    fetchKey(lengthSelect.value, currentType);
                    initialJstDay = currentJstDay;
                }
            }
        }

        // ★★★ 修正: fetchKey関数にtype引数を追加 ★★★
        async function fetchKey(length, type) {
            randomKeyDisplay.textContent = '取得中...';
            keyExpirationSpan.textContent = '...';

            // URLにパラメータを追加
            let requestUrl = `${API_URL}?length=${length}`;
            if (type === 'numeric') {
                requestUrl += '&type=numeric';
            }

            try {
                const response = await fetch(requestUrl);
                if (!response.ok) {
                    throw new Error(`HTTPエラー: ${response.status}`);
                }
                const data = await response.json();

                randomKeyDisplay.textContent = data.random_string;
                keyExpirationSpan.textContent = data.expires_at_jst;

            } catch (error) {
                console.error('APIの呼び出しに失敗しました:', error);
                randomKeyDisplay.textContent = '取得に失敗しました';
                keyExpirationSpan.textContent = '---';
            }
        }

        // --- イベントリスナーと初期化処理 ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. 桁数設定をクッキーから復元
            const savedLength = getCookie('preferredKeyLength');
            lengthSelect.value = savedLength ? savedLength : '15';

            // ★★★ 追加: タイプの選択状態をクッキーから復元 ★★★
            const savedType = getCookie('preferredKeyType');
            numericOnlyCheckbox.checked = (savedType === 'numeric');

            // 2. 現在時刻の表示を開始
            initialJstDay = new Date().toLocaleString('en-US', { timeZone: 'Asia/Tokyo', day: 'numeric' });
            updateJapanTime();
            setInterval(updateJapanTime, 1000);

            // 3. ページロード時に初回API呼び出し
            const initialType = numericOnlyCheckbox.checked ? 'numeric' : 'alphanumeric';
            fetchKey(lengthSelect.value, initialType);
        });

        // 桁数セレクトボックスのイベントリスナー
        lengthSelect.addEventListener('change', () => {
            const selectedLength = lengthSelect.value;
            const currentType = numericOnlyCheckbox.checked ? 'numeric' : 'alphanumeric';
            setCookie('preferredKeyLength', selectedLength);
            fetchKey(selectedLength, currentType);
        });

        // ★★★ 追加: 数字のみスイッチのイベントリスナー ★★★
        numericOnlyCheckbox.addEventListener('change', () => {
            const newType = numericOnlyCheckbox.checked ? 'numeric' : 'alphanumeric';
            setCookie('preferredKeyType', newType);
            fetchKey(lengthSelect.value, newType);
        });
    </script>
</body>
</html>